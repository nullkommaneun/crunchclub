<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CrunchClub ¬∑ 8-Bit Stempelkarte</title>
  <meta name="color-scheme" content="light dark">
  <style>
    /* ===== 8-BIT LOOK & FEEL ===== */
    :root{
      --bg:#0a0f18; --fg:#e6e7ea; --muted:#9aa3b2; --border:#1d2738;
      --panel:#0f1626; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444; --accent:#ef4444;
      --coin1:#fcd34d; --coin2:#f59e0b; --coin3:#b45309; --coin-hi:#fde68a;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --fg:#0f172a; --muted:#475569; --panel:#ffffff; --border:#e5e7eb; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg, var(--bg), #0b1220 50%, var(--bg));
      color:var(--fg);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    .crt{
      position:fixed; inset:0; pointer-events:none; opacity:.07;
      background-image: linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px);
      background-size: 100% 3px;
    }

    /* Pixel-HUD Kopf */
    .wrap{max-width:920px;margin:0 auto;padding:16px 16px 28px}
    .hud{
      display:flex;align-items:center;justify-content:space-between;
      background:var(--panel); border:4px solid var(--border); border-radius:8px;
      padding:10px 12px; box-shadow:0 8px 0 rgba(0,0,0,.25);
      image-rendering: pixelated;
    }
    .title{
      display:flex; align-items:center; gap:10px;
      font-weight:900; letter-spacing:.5px;
      text-transform:uppercase;
    }
    .title .logo{
      width:32px; height:32px; display:grid; place-items:center;
      background:#c1121f; color:#fff; border:4px solid #7a0b14; border-radius:4px;
      box-shadow: inset 0 0 0 4px rgba(0,0,0,.15);
      font-size:18px; line-height:1;
    }
    .status{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      font-size:12px;
    }
    .chip{
      display:inline-block; padding:4px 8px; border:4px solid var(--border); border-radius:6px;
      background:var(--panel);
      box-shadow:0 4px 0 rgba(0,0,0,.25); font-weight:800;
    }
    .ok{ color:var(--ok) } .warn{ color:var(--warn) } .err{ color:var(--err) }
    .muted{ color:var(--muted) }

    /* Panel */
    .panel{
      margin-top:16px; background:var(--panel); border:4px solid var(--border);
      border-radius:8px; padding:16px; box-shadow:0 10px 0 rgba(0,0,0,.25);
    }

    /* 8-bit Headline */
    h2{
      margin:0 0 6px; font-size:18px; text-transform:uppercase; letter-spacing:.5px; font-weight:900;
    }
    p{ margin:6px 0 }

    /* Coin Grid */
    .coins-wrap{ margin-top:10px }
    .coins-bar{
      display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
    }
    .coins-bar .counter{
      font-weight:900; text-transform:uppercase;
    }
    .grid{
      --size:42px;
      margin-top:12px;
      display:grid;
      grid-template-columns: repeat(auto-fit, minmax(var(--size), 1fr));
      gap:10px;
    }
    .coin{
      width:var(--size); height:var(--size);
      border-radius:6px;
      border:4px solid #2b1d00;
      background:
        radial-gradient(50% 50% at 35% 30%, var(--coin-hi) 0%, transparent 60%),
        linear-gradient(180deg, var(--coin1) 0%, var(--coin2) 60%, var(--coin3) 100%);
      box-shadow:
        inset -4px -4px 0 rgba(0,0,0,.25),
        inset  4px  4px 0 rgba(255,255,255,.08),
        0 6px 0 #1f1400;
      display:grid; place-items:center;
      font-weight:900; color:#3b2900; text-shadow:0 1px 0 rgba(255,255,255,.2);
      image-rendering: pixelated;
    }
    .coin::after{ content:"‚óè"; transform:scale(1.1) }
    .coin.mystery{ filter:saturate(.2) contrast(.9); position:relative }
    .coin.mystery::after{ content:"?"; color:#1a1200 }

    .legend{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-top:10px; font-size:12px;
    }
    .mini{ width:18px; height:18px; border:3px solid #2b1d00; border-radius:4px;
      background:linear-gradient(180deg, var(--coin1), var(--coin3));
      box-shadow: inset -2px -2px 0 rgba(0,0,0,.25), inset 2px 2px 0 rgba(255,255,255,.08);
    }

    /* User-ID Block */
    .idbox{
      margin-top:16px; padding:12px; border:4px solid var(--border); border-radius:8px;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(0,0,0,.08));
    }
    .idrow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .mono{ font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace }
    .idcode{ padding:8px 10px; border:4px solid var(--border); border-radius:6px; background:#0b1220; word-break:break-all }
    .btn{
      appearance:none; cursor:pointer; font-weight:900; text-transform:uppercase; letter-spacing:.5px;
      padding:8px 12px; border:4px solid var(--border); border-radius:6px; background:#0b1220; color:var(--fg);
      box-shadow:0 6px 0 rgba(0,0,0,.25);
    }
    .btn:active{ transform:translateY(2px); box-shadow:0 4px 0 rgba(0,0,0,.25) }
    .btn-primary{ background:#1b2a44 }
    .btn-ghost{ background:transparent }

    /* Actions unten */
    .actions{ margin-top:14px; display:flex; gap:8px; flex-wrap:wrap }

    /* Footer */
    footer{ margin:18px 0; color:var(--muted); font-size:12px; text-align:center }
  </style>
</head>
<body>
  <div class="crt" aria-hidden="true"></div>
  <div class="wrap">

    <!-- HUD -->
    <div class="hud">
      <div class="title">
        <div class="logo">CC</div>
        <div>CrunchClub ¬∑ 8-Bit Stempelkarte</div>
      </div>
      <div class="status">
        <span id="badge" class="chip">Status ‚Ä¶</span>
        <span id="badge2" class="chip muted">‚Äì</span>
      </div>
    </div>

    <!-- Hauptpanel -->
    <section class="panel">
      <h2 id="headline">‚Äì</h2>
      <p id="explain" class="muted">‚Äì</p>

      <!-- COIN COLLECTION -->
      <div class="coins-wrap">
        <div class="coins-bar">
          <div class="counter"><span id="coinCount">0</span> M√ºnzen gesammelt</div>
          <div class="muted">Standort: <b id="kv_venue">‚Äì</b> ¬∑ <span id="kv_time">‚Äì</span></div>
        </div>

        <div id="coinGrid" class="grid" aria-live="polite"></div>

        <div class="legend">
          <div class="mini" aria-hidden="true"></div> = 1 QR-Code eingel√∂st
          <span class="muted">¬∑</span>
          <span class="muted">‚Äû?‚Äú = vom Server best√§tigt, lokal nicht zugeordnet</span>
        </div>
      </div>

      <!-- USER ID -->
      <div class="idbox">
        <p><b>Deine CrunchClub-ID</b> (wie eine digitale Stempelkarte):</p>
        <div class="idrow">
          <code id="cid" class="mono idcode"></code>
          <button id="copyBtn" class="btn btn-primary">üìã Kopieren</button>
        </div>
        <p class="muted" style="margin-top:6px">
          Diese ID gut aufbewahren. Mit ihr bleibt deine Sammlung erhalten.
          Geht sie verloren (neues Ger√§t/Inkognito), beginnt die Karte von vorn.
        </p>
        <div id="welcome" class="chip ok" style="margin-top:8px; display:none">‚òÖ Willkommen im exklusiven CrunchClub!</div>
      </div>

      <!-- ACTIONS -->
      <div class="actions">
        <button id="retry" class="btn btn-primary">Erneut scannen</button>
        <button id="reset" class="btn">ID zur√ºcksetzen</button>
        <a href="#"
           id="saveTxt"
           class="btn btn-ghost"
           download="CrunchClub-ID.txt">Als Notiz speichern</a>
      </div>
    </section>

    <footer>
      Anonyme Technikdaten: Zeit, Token, anonyme Client-ID. Kein Website-Tracking.
    </footer>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const qs = new URLSearchParams(location.search);

  // ----- Client-ID Handling -----
  function getCID(){
    try{
      let id = localStorage.getItem('cc_client_id');
      if(!id){ id = crypto.randomUUID(); localStorage.setItem('cc_client_id', id); }
      return id;
    }catch(e){ return '(kein Storage)'; }
  }
  function resetCID(){
    try{ localStorage.removeItem('cc_client_id'); localStorage.removeItem('cc_tokens'); }catch(e){}
    location.reload();
  }

  // ----- Coins (lokal je Client-ID) -----
  // Wir speichern die Liste der einzigartigen Tokens lokal (pro Client).
  function loadTokenSet(){
    try{
      const raw = localStorage.getItem('cc_tokens');
      const arr = raw ? JSON.parse(raw) : [];
      return new Set(arr);
    }catch(e){ return new Set(); }
  }
  function saveTokenSet(set){
    try{
      localStorage.setItem('cc_tokens', JSON.stringify(Array.from(set)));
    }catch(e){}
  }

  // ----- Query-Werte vom Redirect -----
  const registered = qs.get('registered'); // "1"|"0"
  const state = (qs.get('state')||'').toLowerCase(); // new_member|welcome_back|already
  const reason = (qs.get('reason')||'').toLowerCase();
  const ven = qs.get('ven') || 'crunchclub-zwickau';
  const tk  = qs.get('tk') || '';          // aktueller Token
  const mt  = Number(qs.get('mt')||0);     // visits_total
  const tt  = Number(qs.get('tt')||0);     // tokens_seen_total (einzigartige Tokens)
  const tsc = Number(qs.get('tsc')||0);    // Count dieses Tokens
  const camp= qs.get('camp') || '';

  // ----- Basics anzeigen -----
  $('kv_time').textContent  = new Date().toLocaleString('de-DE');
  $('kv_venue').textContent = ven;
  const cid = getCID();
  $('cid').textContent = cid;

  // Notiz-Download vorbereiten
  (function(){
    const body = `${cid}\nHinweis: Diese ID ist deine digitale Stempelkarte.`;
    const blob = new Blob([body], {type:'text/plain'});
    const url  = URL.createObjectURL(blob);
    $('saveTxt').href = url;
    // URL sp√§ter wieder freigeben wenn n√∂tig
  })();

  // Kopieren
  $('copyBtn').onclick = () => {
    navigator.clipboard.writeText(cid).then(()=> {
      $('copyBtn').textContent = '‚úî Kopiert';
      setTimeout(()=>{$('copyBtn').textContent='üìã Kopieren'}, 1200);
    });
  };

  // Badge-Helfer
  function setBadges(kind, msg, sub){
    const b = $('badge'); const b2 = $('badge2');
    b.className = 'chip ' + (kind==='ok'?'ok':kind==='warn'?'warn':kind==='err'?'err':'');
    b.textContent = msg;
    b2.textContent = sub || '';
    b2.className = 'chip muted';
  }

  // ----- Sammlung aktualisieren -----
  const tokenSet = loadTokenSet();

  if (registered === '1') {
    // State-abh√§ngige Texte
    if (state === 'new_member') {
      setBadges('ok','Neu registriert','Erstbesuch ‚úì');
      $('headline').textContent = 'Level 1 erreicht!';
      $('explain').textContent  = 'Dein Abenteuer im CrunchClub hat begonnen.';
      $('welcome').style.display = 'inline-block';
      if (tk) tokenSet.add(tk);

    } else if (state === 'welcome_back') {
      setBadges('ok','Welcome Back','Neuer Code gez√§hlt');
      $('headline').textContent = 'M√ºnze eingesackt!';
      $('explain').textContent  = 'Du hast einen neuen QR-Code eingel√∂st.';
      if (tk) tokenSet.add(tk);

    } else if (state === 'already') {
      setBadges('warn','Code bereits eingel√∂st','Keine doppelte M√ºnze');
      $('headline').textContent = 'Schon eingesammelt.';
      $('explain').textContent  = 'Dieser QR-Code wurde bei dir bereits gewertet.';
      // kein Add

    } else {
      setBadges('warn','Unklar','Bitte erneut scannen');
      $('headline').textContent = 'Hmm ‚Ä¶';
      $('explain').textContent  = 'Kein klarer Status. Bitte QR erneut scannen.';
    }
  } else {
    // Fehlerf√§lle
    const map = {
      rate:['err','Zu viele Scans','Kurze Pause einlegen'],
      venue:['err','Falscher Standort','QR gilt hier nicht'],
      invalid:['err','QR ung√ºltig','Bitte akt. QR scannen'],
      expired:['err','QR abgelaufen','Neuen QR verwenden'],
      inactive:['err','QR deaktiviert','QR am Tresen anfordern'],
      param:['err','Parameter fehlen','Bitte QR erneut scannen'],
      server:['err','Server-Fehler','Bitte sp√§ter erneut']
    };
    const v = map[reason] || ['warn','Unklar','Nochmal scannen'];
    setBadges(v[0], v[1], v[2]);
    $('headline').textContent = 'Fehler/Unklar';
    $('explain').textContent  = 'Dieser Aufruf konnte nicht gewertet werden.';
  }

  // Speichern (nur wenn sich etwas ge√§ndert hat)
  saveTokenSet(tokenSet);

  // ----- Rendering Coin-Grid -----
  // Autoritativ: tt vom Server (unique Tokens insgesamt)
  // Lokal: tokenSet.size; fehlende werden als "mystery" Coins aufgef√ºllt.
  const localCount = tokenSet.size;
  const targetCount = Math.max(localCount, tt);
  const grid = $('coinGrid');
  grid.innerHTML = '';

  // Render reale Coins (aus bekannten Tokens)
  for (const _ of tokenSet) {
    const div = document.createElement('div');
    div.className = 'coin';
    grid.appendChild(div);
  }
  // Erg√§nze Mystery-Coins, falls Server mehr wei√ü
  for (let i = localCount; i < targetCount; i++) {
    const div = document.createElement('div');
    div.className = 'coin mystery';
    grid.appendChild(div);
  }
  $('coinCount').textContent = String(targetCount);

  // ----- Buttons -----
  $('retry').onclick = () => {
    if (document.referrer && /script\.google\.com/.test(document.referrer)) location.reload();
    else history.length>1 ? history.back() : window.location.assign('/');
  };
  $('reset').onclick = resetCID;
})();
</script>
</body>
</html>
