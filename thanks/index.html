<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CrunchClub ‚Äì Registrierung</title>
<meta name="color-scheme" content="light dark">
<meta http-equiv="Cache-Control" content="no-store" />
<style>
  /* ========= Design-System ========= */
  :root {
    --bg: #0b0f1a;            /* dunkler, satter Hintergrund */
    --panel: #0f1629;         /* Kartenfl√§che */
    --glass: rgba(255,255,255,.06);
    --text: #e5e7eb;
    --muted: #96a0b5;
    --ok: #22c55e;
    --warn: #f59e0b;
    --err: #ef4444;
    --brand1: #06b6d4;        /* Neon Cyan */
    --brand2: #a855f7;        /* Neon Violett */
    --accent: #67e8f9;
    --border: rgba(255,255,255,.14);
    --shadow: 0 10px 30px rgba(0,0,0,.35);
    --round: 16px;
  }
  @media (prefers-color-scheme: light) {
    :root { --bg: #0b0f1a; } /* Wir bleiben bewusst dark f√ºr Neon-Brand */
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--text);
    font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial}
  a{color:var(--accent);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:1100px;margin:0 auto;padding:24px 16px 64px}

  /* ========= Header / Hero ========= */
  .hero{
    position:relative;border-radius:calc(var(--round) * 1.2);
    padding:20px;border:1px solid var(--border);overflow:hidden;background:linear-gradient(135deg, rgba(168,85,247,.06), rgba(6,182,212,.06));
  }
  .brand-row{display:flex;align-items:center;gap:14px}
  .logo{
    width:52px;height:52px;border-radius:12px;overflow:hidden;flex:0 0 auto;
    background: radial-gradient(120% 120% at 10% 10%, #ffffff22 0%, #00000000 60%), #0c1324;
    border:1px solid var(--border);
  }
  .logo img{width:100%;height:100%;object-fit:cover;display:block}
  .title{font-size:1.7rem;margin:0;letter-spacing:.3px}
  .subtitle{margin:0;color:var(--muted)}

  /* Glowing border */
  .glow{
    position:absolute;inset:-2px;border-radius:inherit;pointer-events:none;
    background:
      radial-gradient(40% 60% at 10% 10%, rgba(6,182,212,.25), transparent 60%),
      radial-gradient(50% 70% at 90% 20%, rgba(168,85,247,.25), transparent 70%);
    filter: blur(30px); opacity:.7;
  }

  /* ========= Status Card ========= */
  .card{
    margin-top:18px;background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.04));
    border:1px solid var(--border); border-radius:var(--round); padding:20px; box-shadow:var(--shadow);
    backdrop-filter: blur(10px);
  }
  .row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
  @media (max-width:860px){.row{grid-template-columns:1fr}}
  .statusBadge{
    display:inline-flex; align-items:center; gap:10px; padding:10px 14px; border-radius:999px;
    border:1px solid var(--border); background:var(--glass); font-weight:700;
  }
  .ok{ color:var(--ok); border-color:#1f8a4a}
  .warn{ color:var(--warn); border-color:#a96f07}
  .err{ color:var(--err); border-color:#b33636}

  .kv{display:grid;grid-template-columns:160px 1fr;gap:8px 16px;margin-top:14px}
  .k{color:var(--muted)}
  .hr{height:1px;background:var(--border);margin:18px 0}

  /* ========= CTA Buttons ========= */
  .actions{display:flex;gap:10px;flex-wrap:wrap}
  .btn{
    appearance:none;border:0;border-radius:12px;padding:12px 16px;cursor:pointer;color:#061018;
    background: linear-gradient(135deg, var(--brand1), var(--brand2));
    font-weight:700; box-shadow: 0 6px 18px rgba(6,182,212,.35);
  }
  .btn.secondary{
    color:var(--text);
    background:linear-gradient(135deg, #111827, #0b1222);
    border:1px solid var(--border); box-shadow:none;
  }

  /* ========= Info Leiste ========= */
  .infobar{
    margin-top:18px; display:grid; grid-template-columns:2fr 1fr; gap:14px;
  }
  @media (max-width:860px){.infobar{grid-template-columns:1fr}}
  .panel{background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.035));
    border:1px solid var(--border); border-radius:var(--round); padding:16px}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:var(--glass);border:1px solid var(--border);margin:4px 6px 0 0}
  .hours{display:grid;grid-template-columns:130px 1fr;gap:8px 14px;margin-top:8px}
  .open{color:var(--ok);font-weight:700}

  /* ========= Speisekarten-Teaser ========= */
  .menu-strip{display:flex;gap:10px;overflow:auto;padding-bottom:6px;scroll-snap-type:x mandatory}
  .tile{
    min-width:230px;border-radius:14px;border:1px solid var(--border);scroll-snap-align:start;
    background:#0c1324;overflow:hidden; position:relative;
  }
  .tile img{width:100%;height:150px;object-fit:cover;display:block}
  .tile h4{margin:10px 12px 6px 12px;font-size:1.05rem}
  .tile p{margin:0 12px 12px 12px;color:var(--muted);font-size:.95rem}
  .price{position:absolute;top:10px;right:10px;background:var(--glass);border:1px solid var(--border);padding:6px 10px;border-radius:999px}

  /* ========= Instagram Grid ========= */
  .iggrid{display:grid;grid-template-columns:repeat(6,1fr);gap:8px}
  @media (max-width:1200px){.iggrid{grid-template-columns:repeat(4,1fr)}}
  @media (max-width:780px){.iggrid{grid-template-columns:repeat(3,1fr)}}
  @media (max-width:520px){.iggrid{grid-template-columns:repeat(2,1fr)}}
  .iggrid a{display:block;aspect-ratio:1/1;border-radius:10px;overflow:hidden;border:1px solid var(--border);background:#0c1324}
  .iggrid img{width:100%;height:100%;object-fit:cover;display:block;transition: transform .35s ease}
  .iggrid a:hover img{transform: scale(1.05)}

  /* ========= Check Animation ========= */
  .check{
    width:22px;height:22px;border-radius:50%;display:inline-grid;place-items:center;
    background:radial-gradient(60% 60% at 50% 50%, #22c55e 0%, #0b1b12 70%);
    box-shadow:0 0 25px rgba(34,197,94,.55), inset 0 0 14px rgba(34,197,94,.65);
    animation:pop .6s ease both
  }
  .check svg{fill:#031a0f}
  @keyframes pop{0%{transform:scale(.6);opacity:.6}100%{transform:scale(1);opacity:1}}

  /* ========= Debug minimal Toggle ========= */
  .debug{margin-top:14px;color:var(--muted);font-size:.9rem}
  .debug small{opacity:.8}
</style>
</head>
<body>
<div class="wrap">

  <!-- HERO -->
  <section class="hero">
    <div class="glow"></div>
    <div class="brand-row">
      <div class="logo">
        <!-- Ersetze durch dein Logo -->
        <img src="/crunchclub/assets/img/logo.png" alt="CrunchClub Logo" onerror="this.style.display='none'">
      </div>
      <div>
        <h1 class="title">CrunchClub ‚Äì Registrierung</h1>
        <p class="subtitle">Ramen ‚Ä¢ Burritos ‚Ä¢ Tacos ‚Ä¢ Fries ‚Äì Zwickau</p>
      </div>
    </div>

    <!-- STATUS CARD -->
    <div class="card">
      <span id="badge" class="statusBadge warn">
        <span class="check" id="chk" style="display:none"><svg width="14" height="14" viewBox="0 0 24 24"><path d="M9 16.2l-3.5-3.5-1.4 1.4L9 19 20 8l-1.4-1.4z"/></svg></span>
        <span id="badgeText">Status wird gepr√ºft ‚Ä¶</span>
      </span>

      <div class="row" style="margin-top:14px">
        <div>
          <div class="kv">
            <div class="k">Status</div><div id="kv_status">‚Äì</div>
            <div class="k">Standort</div><div id="kv_venue">‚Äì</div>
            <div class="k">Zeit</div><div id="kv_time">‚Äì</div>
            <div class="k">Client-ID</div><div id="kv_cid">‚Äì</div>
          </div>
          <div class="hr"></div>
          <div id="tips" style="color:var(--muted)"></div>

          <div class="actions" style="margin-top:14px">
            <button id="retry" class="btn">Erneut scannen</button>
            <button id="reset" class="btn secondary">Client-ID zur√ºcksetzen</button>
            <a id="menuBtn" class="btn secondary" href="/crunchclub/#menu">Zur Speisekarte</a>
          </div>
        </div>

        <!-- Menu Teaser -->
        <div>
          <h3 style="margin:0 0 8px 0">Heute beliebt</h3>
          <div class="menu-strip">
            <!-- Ersetze Bilder/Texte durch echte Items -->
            <article class="tile">
              <img src="/crunchclub/assets/img/ramen.jpg" alt="Tonkotsu Ramen">
              <div class="price">ab 9,90 ‚Ç¨</div>
              <h4>Tonkotsu Ramen</h4>
              <p>Cremige Br√ºhe, eigene Toppings ‚Äì ‚ÄûDeine Ramen, dein Style‚Äú.</p>
            </article>
            <article class="tile">
              <img src="/crunchclub/assets/img/burrito.jpg" alt="Burrito Guacamole">
              <div class="price">ab 7,90 ‚Ç¨</div>
              <h4>Burrito Guacamole</h4>
              <p>Frisch gerollt, Bohnen, Reis, Proteine frei w√§hlbar.</p>
            </article>
            <article class="tile">
              <img src="/crunchclub/assets/img/fries.jpg" alt="Fries Guac-Style">
              <div class="price">5,50 ‚Ç¨</div>
              <h4>Fries ‚ÄûGuac-Style‚Äú</h4>
              <p>Knusprig + Avocado-Kick. Perfekt als Side.</p>
            </article>
          </div>
        </div>
      </div>
    </div>

    <!-- Infoleiste: √ñffnungszeiten & Adresse -->
    <div class="infobar">
      <div class="panel">
        <div class="chip">üìç Innere Schneeberger Str. 17, 08056 Zwickau</div>
        <div class="hours" id="hours">
          <!-- wird aus JSON unten gef√ºllt -->
        </div>
      </div>
      <div class="panel">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:10px">
          <strong>Folge uns</strong>
          <a href="https://instagram.com/crunchclub_zwickau" target="_blank" rel="noopener">Instagram ‚Üí</a>
        </div>
        <div class="hr" style="margin:10px 0"></div>
        <div class="iggrid" id="ig">
          <!-- statische Vorschaubilder (du ersetzt sie durch deine IG-Bilder) -->
          <a href="https://instagram.com/crunchclub_zwickau" target="_blank" rel="noopener"><img src="/crunchclub/assets/img/ig1.jpg" alt=""></a>
          <a href="https://instagram.com/crunchclub_zwickau" target="_blank" rel="noopener"><img src="/crunchclub/assets/img/ig2.jpg" alt=""></a>
          <a href="https://instagram.com/crunchclub_zwickau" target="_blank" rel="noopener"><img src="/crunchclub/assets/img/ig3.jpg" alt=""></a>
          <a href="https://instagram.com/crunchclub_zwickau" target="_blank" rel="noopener"><img src="/crunchclub/assets/img/ig4.jpg" alt=""></a>
          <a href="https://instagram.com/crunchclub_zwickau" target="_blank" rel="noopener"><img src="/crunchclub/assets/img/ig5.jpg" alt=""></a>
          <a href="https://instagram.com/crunchclub_zwickau" target="_blank" rel="noopener"><img src="/crunchclub/assets/img/ig6.jpg" alt=""></a>
        </div>
      </div>
    </div>

    <div class="debug"><small>Es werden nur anonyme technische Daten verarbeitet (Zeit, Token, anonyme Client-ID). Kein tracking √ºber Websites hinweg.</small></div>
  </section>
</div>

<script>
(function(){
  // ===== Basic helpers
  const qs = new URLSearchParams(location.search);
  const ven = qs.get('ven') || 'CrunchClub Zwickau';
  const registered = qs.get('registered'); // "1" | "0" | null
  const reason = (qs.get('reason')||'').toLowerCase();

  function set(id, html){ document.getElementById(id).innerHTML = html; }
  function badge(cls, text){ const b=document.getElementById('badge'); b.className='statusBadge '+cls; set('badgeText', text); }
  function cidGet(){ try{ let id=localStorage.getItem('cc_client_id'); if(!id){ id=crypto.randomUUID(); localStorage.setItem('cc_client_id', id);} return id; }catch(e){ return '(kein Storage)'; } }
  function advice(html){ document.getElementById('tips').innerHTML = html; }
  function nowStr(){ return new Date().toLocaleString(); }

  // ===== √ñffnungszeiten (ersetzen mit echten Zeiten)
  const HOURS = [
    {d:'Montag',    h:'11:00 ‚Äì 21:00'},
    {d:'Dienstag',  h:'11:00 ‚Äì 21:00'},
    {d:'Mittwoch',  h:'11:00 ‚Äì 21:00'},
    {d:'Donnerstag',h:'11:00 ‚Äì 21:00'},
    {d:'Freitag',   h:'11:00 ‚Äì 21:30'},
    {d:'Samstag',   h:'11:00 ‚Äì 21:30'},
    {d:'Sonntag',   h:'geschlossen'}
  ];
  const today = new Date().getDay(); // So=0..Sa=6
  const mapIdx = {1:0,2:1,3:2,4:3,5:4,6:5,0:6};
  const openHTML = HOURS.map((r,i)=>{
    const isToday = i === mapIdx[today];
    return `<div class="k">${r.d}${isToday? ' <span class="chip open">heute</span>':''}</div><div>${r.h}</div>`;
  }).join('');
  set('hours', openHTML);

  // ===== Sichtbare Felder
  set('kv_time', nowStr());
  set('kv_venue', ven);
  set('kv_cid', cidGet());

  // ===== Zust√§nde & Texte
  const STATES = {
    success: {
      kv: 'Erfolgreich',
      badge: ['ok','‚úì Registrierung erfolgreich'],
      tip: `<ul style="margin:0 0 0 18px;padding:0">
              <li>Best√§tigung bei Bedarf am Tresen zeigen.</li>
              <li>F√ºr Loyalty-Punkte einfach bei jedem Besuch scannen.</li>
            </ul>`
    },
    dupe: {
      kv: 'Nicht gespeichert (dupe)',
      badge: ['err','‚ö†Ô∏è Heute bereits registriert'],
      tip: `<b>Hinweis</b> pro Ger√§t & Token nur <b>1√ó pro Tag</b>.<br>Sp√§ter erneut scannen.`
    },
    rate: {
      kv: 'Nicht gespeichert (rate)',
      badge: ['err','‚ö†Ô∏è Zu viele Scans'],
      tip: `Bitte 1‚Äì2 Minuten warten und erneut scannen.`
    },
    invalid: {
      kv: 'Nicht gespeichert (invalid)',
      badge: ['err','‚ö†Ô∏è Ung√ºltiger QR'],
      tip: `Veraltet oder Parameter fehlen. Bitte aktuellen QR am Tresen scannen.`
    },
    expired: {
      kv: 'Nicht gespeichert (expired)',
      badge: ['err','‚ö†Ô∏è QR abgelaufen'],
      tip: `Bitte aktuellen QR verwenden (Poster am Tresen).`
    },
    inactive: {
      kv: 'Nicht gespeichert (inactive)',
      badge: ['err','‚ö†Ô∏è QR deaktiviert'],
      tip: `Bitte neuen QR am Tresen anfordern.`
    },
    venue: {
      kv: 'Nicht gespeichert (venue)',
      badge: ['err','‚ö†Ô∏è Standort stimmt nicht'],
      tip: `Dieser QR gilt nicht f√ºr diesen Standort.`
    },
    param: {
      kv: 'Nicht gespeichert (param)',
      badge: ['err','‚ö†Ô∏è Parameter fehlen'],
      tip: `Bitte QR erneut scannen.`
    },
    server: {
      kv: 'Nicht gespeichert (server)',
      badge: ['err','‚ö†Ô∏è Vor√ºbergehender Fehler'],
      tip: `Bitte in wenigen Minuten erneut versuchen.`
    },
    unknown: {
      kv: 'Unbekannt',
      badge: ['warn','‚ÑπÔ∏è Unklarer Status'],
      tip: `Diese Seite wurde ohne g√ºltigen Status aufgerufen. Bitte QR erneut scannen.`
    }
  };

  // Status ableiten
  let view;
  if (registered === '1') view = STATES.success;
  else if (registered === '0') view = STATES[reason] || STATES.unknown;
  else view = STATES.unknown;

  // UI setzen
  set('kv_status', view.kv);
  badge(view.badge[0], view.badge[1]);
  advice(view.tip);
  if (registered === '1') document.getElementById('chk').style.display = 'grid';

  // Aktionen
  document.getElementById('retry').onclick = ()=> {
    if (document.referrer && /script\.google\.com/.test(document.referrer)) location.reload();
    else history.length>1 ? history.back() : window.location.href = '/crunchclub/';
  };
  document.getElementById('reset').onclick = ()=> {
    try{ localStorage.removeItem('cc_client_id'); alert('Client-ID zur√ºckgesetzt. Bitte erneut scannen.'); location.reload(); }catch(e){}
  };
})();
</script>
</body>
</html></style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div id="badge" class="status warn">Lade ‚Ä¶</div>
    <h1 id="title">CrunchClub ‚Äì Registrierung</h1>
    <p id="lead" class="lead">Bitte einen Moment.</p>

    <div class="grid">
      <div class="k">Status</div><div id="kv_status">‚Äì</div>
      <div class="k">Standort</div><div id="kv_venue">‚Äì</div>
      <div class="k">Zeit</div><div id="kv_time">‚Äì</div>
      <div class="k">Client-ID</div><div id="kv_cid">‚Äì</div>
    </div>

    <div class="hr"></div>

    <div id="tips" class="tips"></div>

    <div class="actions">
      <button id="retry" class="btn">Erneut versuchen</button>
      <button id="reset" class="btn secondary">Client-ID zur√ºcksetzen</button>
      <a id="home" class="btn secondary" style="text-decoration:none" href="/">Zur Startseite</a>
    </div>

    <details class="debug" id="debugBox">
      <summary>Entwickler/Debug-Infos (sp√§ter entfernen)</summary>
      <p class="mono">Query-Parameter</p>
      <pre id="qp" class="mono"></pre>
      <p class="mono">Lokaler Zustand</p>
      <pre id="state" class="mono"></pre>
      <p class="mono">Browser</p>
      <pre id="ua" class="mono"></pre>
      <div class="actions">
        <button id="copy" class="btn secondary">Debug-JSON kopieren</button>
      </div>
    </details>

    <p class="lead" style="margin-top:14px">
      Hinweis: Es werden nur anonyme technische Daten (Zeit, Token, anonyme Client-ID) verarbeitet.
    </p>
  </div>
</div>

<script>
(function(){
  // ------ Helpers
  const qs = new URLSearchParams(location.search);
  function cidGet(){ try{ let id = localStorage.getItem('cc_client_id'); if(!id){ id = crypto.randomUUID(); localStorage.setItem('cc_client_id', id); } return id; }catch(e){ return '(kein Storage)'; } }
  function cidReset(){ try{ localStorage.removeItem('cc_client_id'); }catch(e){} }
  function set(el, html){ document.getElementById(el).innerHTML = html; }
  function badge(cls, text){ const b = document.getElementById('badge'); b.className = 'status ' + cls; b.textContent = text; }
  function advice(html){ set('tips', html); }

  // ------ Inputs aus Redirect
  const registered = qs.get('registered');   // "1" | "0" | null
  const reason     = qs.get('reason');       // "dupe" | "rate" | "invalid" | "expired" | "inactive" | "venue" | "param" | "server" | ...
  const ven        = qs.get('ven') || 'unbekannt';

  // ------ Sichtbare Felder
  const now = new Date();
  set('kv_time', now.toLocaleString());
  set('kv_venue', ven);
  const cid = cidGet();
  set('kv_cid', cid);

  // ------ Zust√§nde
  const STATES = {
    success: {
      title: 'Danke f√ºr deinen Besuch!',
      lead : 'Dein Scan wurde registriert. Viel Spa√ü beim Essen!',
      status: 'Erfolgreich',
      badge : ['ok','‚úì Registrierung erfolgreich'],
      tips  : `
        <ul style="margin:0 0 0 18px;padding:0">
          <li>Zeig diese Best√§tigung bei Bedarf am Tresen.</li>
          <li>Bewahre diese Seite nicht auf ‚Äì beim n√§chsten Besuch einfach neu scannen.</li>
        </ul>`
    },
    dupe: {
      title: 'Heute bereits registriert',
      lead : 'F√ºr fairen Betrieb z√§hlt pro Ger√§t & Token nur eine Registrierung pro Tag.',
      status: 'Nicht gespeichert (dupe)',
      badge : ['err','‚ö†Ô∏è Heute bereits registriert'],
      tips  : `
        <b>Was tun?</b>
        <ul style="margin:0 0 0 18px;padding:0">
          <li>Sp√§ter erneut scannen (morgen wieder m√∂glich).</li>
          <li>Falls versehentlich: am Tresen melden.</li>
        </ul>`
    },
    rate: {
      title: 'Zu viele Scans',
      lead : 'Kurzzeitig wurden zu viele Scans erkannt.',
      status: 'Nicht gespeichert (rate)',
      badge : ['err','‚ö†Ô∏è Zu viele Scans'],
      tips  : `
        <b>Was tun?</b>
        <ul style="margin:0 0 0 18px;padding:0">
          <li>Bitte 1‚Äì2 Minuten warten und erneut scannen.</li>
          <li>Nur einmal pro Person scannen.</li>
        </ul>`
    },
    invalid: {
      title: 'Ung√ºltiger QR',
      lead : 'Dieser QR-Code ist nicht g√ºltig.',
      status: 'Nicht gespeichert (invalid)',
      badge : ['err','‚ö†Ô∏è Ung√ºltiger QR'],
      tips  : `
        <b>M√∂gliche Ursachen</b>
        <ul style="margin:0 0 0 18px;padding:0">
          <li>Veraltetes/abfotografiertes Poster.</li>
          <li>Falscher Link (Parameter fehlen).</li>
        </ul>
        <b>Ma√ünahme</b>: Bitte einen aktuellen QR am Tresen scannen.`
    },
    expired: {
      title: 'QR abgelaufen',
      lead : 'Der Token ist abgelaufen (Zeitfenster √ºberschritten).',
      status: 'Nicht gespeichert (expired)',
      badge : ['err','‚ö†Ô∏è QR abgelaufen'],
      tips  : `Bitte den <b>aktuellen</b> QR am Tresen scannen.`
    },
    inactive: {
      title: 'QR deaktiviert',
      lead : 'Dieser Token ist aktuell nicht aktiv.',
      status: 'Nicht gespeichert (inactive)',
      badge : ['err','‚ö†Ô∏è QR deaktiviert'],
      tips  : `Bitte neuen QR am Tresen anfordern.`
    },
    venue: {
      title: 'Falscher Standort',
      lead : 'Dieser QR gilt nicht f√ºr diesen Standort.',
      status: 'Nicht gespeichert (venue)',
      badge : ['err','‚ö†Ô∏è Standort stimmt nicht'],
      tips  : `Bitte den QR f√ºr <b>${ven}</b> verwenden.`
    },
    param: {
      title: 'Technischer Fehler (Parameter)',
      lead : 'Es fehlen notwendige Angaben im Link.',
      status: 'Nicht gespeichert (param)',
      badge : ['err','‚ö†Ô∏è Parameter fehlen'],
      tips  : `Bitte QR erneut scannen. Wenn das Problem bleibt, am Tresen melden.`
    },
    server: {
      title: 'Server-Fehler',
      lead : 'Der Eintrag konnte gerade nicht gespeichert werden.',
      status: 'Nicht gespeichert (server)',
      badge : ['err','‚ö†Ô∏è Vor√ºbergehender Fehler'],
      tips  : `Bitte in wenigen Minuten erneut scannen.`
    },
    unknown: {
      title: 'Hinweis',
      lead : 'Diese Seite wurde ohne klaren Status ge√∂ffnet.',
      status: 'Unbekannt',
      badge : ['warn','‚ÑπÔ∏è Unbekannter Status'],
      tips  : `Bitte zur√ºck und QR erneut scannen.`
    }
  };

  // ------ Logik: Status bestimmen
  let view;
  if (registered === '1') {
    view = STATES.success;
  } else if (registered === '0') {
    // Grund auswerten
    switch ((reason||'').toLowerCase()) {
      case 'dupe': view = STATES.dupe; break;
      case 'rate': view = STATES.rate; break;
      case 'invalid': view = STATES.invalid; break;
      case 'expired': view = STATES.expired; break;
      case 'inactive': view = STATES.inactive; break;
      case 'venue': view = STATES.venue; break;
      case 'param': view = STATES.param; break;
      case 'server': view = STATES.server; break;
      default: view = STATES.unknown; break;
    }
  } else {
    view = STATES.unknown;
  }

  // ------ UI setzen
  document.getElementById('title').textContent = 'CrunchClub ‚Äì ' + view.title;
  document.getElementById('lead').textContent  = view.lead;
  document.getElementById('kv_status').textContent = view.status;
  badge(view.badge[0], view.badge[1]);
  advice(view.tips);

  // ------ Aktionen
  document.getElementById('retry').addEventListener('click', ()=> {
    // Wenn wir vom Script kamen, reicht reload; sonst zur Startseite
    if (document.referrer && /script\.google\.com/.test(document.referrer)) {
      location.reload();
    } else {
      history.length > 1 ? history.back() : location.href = '/';
    }
  });
  document.getElementById('reset').addEventListener('click', ()=> {
    cidReset();
    alert('Client-ID zur√ºckgesetzt. Bitte erneut scannen.');
    location.reload();
  });

  // ------ Debug (nur wenn ?debug=1 oder localStorage flag)
  const debugEnabled = qs.get('debug') === '1' || localStorage.getItem('cc_debug') === '1';
  if (!debugEnabled) document.getElementById('debugBox').style.display = 'none';

  // Query-Parameter
  const qp = {}; for (const [k,v] of qs.entries()) qp[k]=v;
  set('qp', JSON.stringify({params: qp, referrer: document.referrer||null}, null, 2));

  // Lokaler Zustand
  const state = {
    time: new Date().toISOString(),
    client_id: cid,
    localStorage: Object.keys(localStorage||{}),
    sessionStorage: Object.keys(sessionStorage||{})
  };
  set('state', JSON.stringify(state, null, 2));

  // Browser
  const ua = {
    userAgent: navigator.userAgent,
    platform: navigator.platform,
    language: navigator.language,
    online: navigator.onLine,
    tz: Intl.DateTimeFormat().resolvedOptions().timeZone,
    viewport: `${innerWidth}x${innerHeight}`
  };
  set('ua', JSON.stringify(ua, null, 2));

  document.getElementById('copy').addEventListener('click', async ()=>{
    const blob = {
      status: { registered, reason, venue: ven },
      qp, state, ua
    };
    const txt = JSON.stringify(blob, null, 2);
    try { await navigator.clipboard.writeText(txt); alert('Debug-JSON kopiert.'); }
    catch(e){ alert('Kopieren nicht erlaubt.'); }
  });
})();
</script>
</body>
</html>
