<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CrunchClub – Registrierung</title>
  <meta name="color-scheme" content="light dark">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="brand">
        <div class="logo" aria-hidden="true">🍜</div>
        <div>
          <h1>CrunchClub – Registrierung</h1>
          <div class="sub">Zwickau · anonym & ohne Anmeldung</div>
        </div>
      </div>
      <div class="divider" aria-hidden="true"></div>
    </header>

    <section class="card" id="panel">
      <div id="badge" class="badge">Status wird geprüft…</div>

      <dl class="grid">
        <dt>Status</dt><dd id="kv_status">–</dd>
        <dt>Standort</dt><dd id="kv_venue">–</dd>
        <dt>Zeit</dt><dd id="kv_time">–</dd>
        <dt>Client-ID</dt><dd id="kv_cid" class="mono ellipsis">–</dd>
        <dt>Code</dt><dd id="kv_token" class="mono">–</dd>
      </dl>

      <h2 id="headline" class="headline">–</h2>
      <div id="explain" class="explain">–</div>

      <div id="counters" class="counters" hidden></div>

      <!-- Hinweisblock für erste Registrierung -->
      <aside id="firstTimeNotice" class="notice" hidden>
        <p><b>Deine persönliche CrunchClub-ID</b> (wie eine digitale Stempelkarte):</p>
        <code id="userId" class="mono blockcode"></code>
        <div class="row">
          <button id="copyBtn" class="btn btn-primary">📋 ID kopieren</button>
          <button id="saveNoteBtn" class="btn">Als Notiz speichern (Tipp)</button>
        </div>
        <p class="muted small">
          Diese ID bitte gut aufbewahren. Mit ihr bleibt deine Stempelkarte erhalten.
          Geht sie verloren (neues Gerät/Inkognito), beginnt die Karte von vorne.
        </p>
      </aside>

      <div class="row actions">
        <button id="retry" class="btn btn-primary">Erneut scannen</button>
        <button id="reset" class="btn">Client-ID zurücksetzen</button>
        <a class="btn" href="#hours">Öffnungszeiten</a>
        <a class="btn" href="https://instagram.com/crunchclub_zwickau" target="_blank" rel="noopener">Instagram</a>
      </div>
    </section>

    <section id="hours" class="card">
      <strong>Öffnungszeiten</strong>
      <dl id="hoursGrid" class="grid hours"></dl>
      <div class="muted small">📍 Innere Schneeberger Str. 17, 08056 Zwickau</div>
    </section>

    <footer class="footer">
      Es werden nur anonyme technische Daten verarbeitet (Zeit, Token, anonyme Client-ID). Kein Tracking über Websites hinweg.
    </footer>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const qs = new URLSearchParams(location.search);

  // Helpers
  const getCID = () => {
    try {
      let id = localStorage.getItem('cc_client_id');
      if (!id) { id = crypto.randomUUID(); localStorage.setItem('cc_client_id', id); }
      return id;
    } catch { return '(kein Storage)'; }
  };
  const resetCID = () => { try{ localStorage.removeItem('cc_client_id'); location.reload(); }catch{} };

  // Öffnungszeiten
  const HOURS = [
    ['Montag','11:00 – 21:00'],
    ['Dienstag','11:00 – 21:00'],
    ['Mittwoch','11:00 – 21:00'],
    ['Donnerstag','11:00 – 21:00'],
    ['Freitag','11:00 – 21:30'],
    ['Samstag','11:00 – 21:30'],
    ['Sonntag','geschlossen'],
  ];
  const dayMap=[6,0,1,2,3,4,5];
  const todayIdx = dayMap[new Date().getDay()];
  $('hoursGrid').innerHTML = HOURS.map((d,i)=>`
    <dt class="${i===todayIdx?'today':''}">${d[0]}</dt>
    <dd class="${i===todayIdx?'today':''}">${d[1]}</dd>
  `).join('');

  // Query-Werte
  const registered = qs.get('registered');
  const state = (qs.get('state')||'').toLowerCase();
  const reason = (qs.get('reason')||'').toLowerCase();
  const ven = qs.get('ven') || 'crunchclub-zwickau';
  const tk  = qs.get('tk') || '';
  const mt  = Number(qs.get('mt')||0);
  const tt  = Number(qs.get('tt')||0);
  const tsc = Number(qs.get('tsc')||0);
  const camp= qs.get('camp') || '';

  // Basics
  $('kv_time').textContent  = new Date().toLocaleString('de-DE');
  $('kv_venue').textContent = ven;
  const cid = getCID();
  $('kv_cid').textContent   = cid;
  $('kv_token').textContent = tk || '—';

  // Badge
  const setBadge = (type, text) => {
    const b = $('badge');
    b.className = `badge ${type}`;
    b.textContent = text;
  };

  // Render States
  if (registered === '1') {
    $('counters').hidden = false;
    $('counters').textContent = `Besuche gesamt: ${mt} • Einzigartige Codes: ${tt}` + (tk ? ` • Scans dieses Codes: ${tsc}`:'');
    switch (state) {
      case 'new_member':
        setBadge('badge-ok','✓ Registrierung erfolgreich (Erstbesuch)');
        $('kv_status').textContent = 'Neu registriert';
        $('headline').textContent  = 'Willkommen beim CrunchClub!';
        $('explain').innerHTML     = `Deine Mitgliedschaft wurde angelegt.${tk ? ' <span class="mono chip">Code: '+tk+'</span>':''}` + (camp? `<div class="muted small" style="margin-top:6px">Kampagne: ${camp}</div>` : '');
        // Hinweisblock
        $('userId').textContent = cid;
        $('firstTimeNotice').hidden = false;
        $('copyBtn').onclick = () => navigator.clipboard.writeText(cid).then(()=> alert('ID kopiert!'));
        $('saveNoteBtn').onclick = () => {
          const title = 'CrunchClub-ID';
          const body  = cid + '\\nHinweis: Diese ID ist deine digitale Stempelkarte.';
          const blob = new Blob([body], {type:'text/plain'});
          const a = document.createElement('a');
          a.href = URL.createObjectURL(blob);
          a.download = `${title}.txt`;
          document.body.appendChild(a);
          a.click();
          a.remove();
          URL.revokeObjectURL(a.href);
        };
        break;

      case 'welcome_back':
        setBadge('badge-ok','✓ Welcome back – neuer Code gezählt');
        $('kv_status').textContent = 'Welcome Back';
        $('headline').textContent  = 'Schön, dich wiederzusehen!';
        $('explain').innerHTML     = `Dieser Code ist neu für dich.${tk ? ' <span class="mono chip">Code: '+tk+'</span>':''}` + (camp? `<div class="muted small" style="margin-top:6px">Kampagne: ${camp}</div>` : '');
        break;

      case 'already':
        setBadge('badge-warn','ℹ️ Code bereits eingelöst');
        $('kv_status').textContent = 'Bereits eingelöst';
        $('headline').textContent  = 'Diesen Code hast du schon benutzt';
        $('explain').innerHTML     = `${tk ? '<span class="mono chip">Code: '+tk+'</span> ' : ''}Keine doppelte Gutschrift – beim nächsten Besuch bitte neuen QR scannen.`;
        break;

      default:
        setBadge('badge-warn','ℹ️ Unklarer Status');
        $('kv_status').textContent = 'Unbekannt';
        $('headline').textContent  = 'Bitte QR erneut scannen';
        $('explain').textContent   = 'Diese Seite wurde ohne klaren Status aufgerufen.';
    }
  } else {
    const map = {
      rate:   ['badge-err','⚠️ Zu viele Scans','Kurz warten und erneut scannen','Bitte 1–2 Minuten warten und dann erneut versuchen.'],
      venue:  ['badge-err','⚠️ Falscher Standort','Dieser QR gilt hier nicht','Bitte den QR für diesen Standort verwenden.'],
      invalid:['badge-err','⚠️ QR ungültig','Dieser QR ist nicht gültig','Der QR ist veraltet oder fehlerhaft. Bitte aktuellen QR scannen.'],
      expired:['badge-err','⚠️ QR abgelaufen','Dieser QR ist abgelaufen','Bitte aktuellen QR am Tresen verwenden.'],
      inactive:['badge-err','⚠️ QR deaktiviert','Dieser QR ist deaktiviert','Bitte neuen QR am Tresen anfordern.'],
      param:  ['badge-err','⚠️ Parameter fehlen','Ungültiger Aufruf','Bitte QR erneut scannen.'],
      server: ['badge-err','⚠️ Vorübergehender Fehler','Da ist etwas schiefgelaufen','Bitte in wenigen Minuten erneut versuchen.'],
    };
    const v = map[reason] || ['badge-warn','ℹ️ Unklarer Status','Bitte QR erneut scannen','Diese Seite wurde ohne klaren Status geöffnet.'];
    setBadge(v[0], v[1]);
    $('kv_status').textContent = v[1].replace(/^⚠️\s*/,'');
    $('headline').textContent  = v[2];
    $('explain').textContent   = v[3];
  }

  // Actions
  $('retry').onclick = () => {
    if (document.referrer && /script\.google\.com/.test(document.referrer)) location.reload();
    else history.length>1 ? history.back() : window.location.assign('/');
  };
  $('reset').onclick = resetCID;
})();
</script>
</body>
</html>
