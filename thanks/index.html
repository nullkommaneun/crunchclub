<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CrunchClub Â· 8-Bit Stempelkarte</title>
  <meta name="color-scheme" content="light dark">
  <style>
    /* ===== 8-BIT LOOK ===== */
    :root{
      --bg:#0a0f18; --fg:#e6e7ea; --muted:#9aa3b2; --panel:#0f1626; --border:#1d2738;
      --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f6f7fb; --fg:#0f172a; --muted:#475569; --panel:#ffffff; --border:#e5e7eb; }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background:linear-gradient(180deg, var(--bg), #0b1220 50%, var(--bg));
      color:var(--fg);
      font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    }
    .crt{position:fixed;inset:0;pointer-events:none;opacity:.07;
      background-image:linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px);
      background-size:100% 3px;}

    .wrap{max-width:920px;margin:0 auto;padding:16px 16px 28px}

    /* HUD */
    .hud{
      display:flex;align-items:center;justify-content:space-between;
      background:var(--panel); border:4px solid var(--border); border-radius:8px;
      padding:10px 12px; box-shadow:0 8px 0 rgba(0,0,0,.25); image-rendering:pixelated;
    }
    .title{display:flex;align-items:center;gap:10px;font-weight:900;letter-spacing:.5px;text-transform:uppercase}
    .logo{width:32px;height:32px;display:grid;place-items:center;background:#c1121f;color:#fff;border:4px solid #7a0b14;border-radius:4px;box-shadow:inset 0 0 0 4px rgba(0,0,0,.15);font-size:18px;line-height:1}
    .chip{display:inline-block;padding:4px 8px;border:4px solid var(--border);border-radius:6px;background:var(--panel);box-shadow:0 4px 0 rgba(0,0,0,.25);font-weight:800}
    .ok{color:var(--ok)} .warn{color:var(--warn)} .err{color:var(--err)}
    .muted{color:var(--muted)}

    /* Panel */
    .panel{margin-top:16px;background:var(--panel);border:4px solid var(--border);border-radius:8px;padding:16px;box-shadow:0 10px 0 rgba(0,0,0,.25)}
    h2{margin:0 0 6px;font-size:18px;text-transform:uppercase;letter-spacing:.5px;font-weight:900}
    p{margin:6px 0}

    /* Coin-Bar & Grid */
    .coins-wrap{margin-top:10px}
    .coins-bar{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .coins-bar .counter{font-weight:900;text-transform:uppercase}
    .grid{--size:44px;margin-top:12px;display:grid;grid-template-columns:repeat(auto-fit,minmax(var(--size),1fr));gap:10px}

    /* 8-bit Pixel Coin via SVG Data URI (crisp, kein External) */
    .coin{
      width:var(--size);height:var(--size);
      image-rendering:pixelated; background-size:contain; background-repeat:no-repeat; background-position:center;
      background-image: url("data:image/svg+xml;utf8,\
<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' shape-rendering='crispEdges'>\
<rect width='16' height='16' fill='none'/>\
<!-- Outline -->\
<rect x='1' y='1' width='14' height='14' fill='#2b1d00'/>\
<rect x='2' y='2' width='12' height='12' fill='#000000' opacity='0.25'/>\
<!-- Coin body -->\
<rect x='2' y='2' width='12' height='12' fill='#f59e0b'/>\
<rect x='2' y='8' width='12' height='6' fill='#b45309'/>\
<rect x='2' y='2' width='12' height='3' fill='#fcd34d'/>\
<!-- Inner rim -->\
<rect x='3' y='3' width='10' height='10' fill='none' stroke='#7c3e06' stroke-width='1'/>\
<!-- Shine -->\
<rect x='4' y='4' width='3' height='1' fill='#fff3b0'/>\
<rect x='5' y='5' width='2' height='1' fill='#fff3b0'/>\
</svg>");
      border-radius:6px;
    }

    /* User-ID Block */
    .idbox{margin-top:16px;padding:12px;border:4px solid var(--border);border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(0,0,0,.08))}
    .idrow{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .idcode{padding:8px 10px;border:4px solid var(--border);border-radius:6px;background:#0b1220;word-break:break-all}
    .btn{appearance:none;cursor:pointer;font-weight:900;text-transform:uppercase;letter-spacing:.5px;padding:8px 12px;border:4px solid var(--border);border-radius:6px;background:#0b1220;color:var(--fg);box-shadow:0 6px 0 rgba(0,0,0,.25)}
    .btn:active{transform:translateY(2px);box-shadow:0 4px 0 rgba(0,0,0,.25)}
    .btn-primary{background:#1b2a44}
    .btn-ghost{background:transparent}
    .actions{margin-top:14px;display:flex;gap:8px;flex-wrap:wrap}
    footer{margin:18px 0;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="crt" aria-hidden="true"></div>
  <div class="wrap">

    <!-- HUD -->
    <div class="hud">
      <div class="title">
        <div class="logo">CC</div>
        <div>CrunchClub Â· 8-Bit Stempelkarte</div>
      </div>
      <div class="status">
        <span id="badge" class="chip">Status â€¦</span>
        <!-- Zweit-Badge bewusst entfernt -->
      </div>
    </div>

    <!-- Panel -->
    <section class="panel">
      <h2 id="headline">â€“</h2>
      <p id="explain" class="muted">â€“</p>

      <!-- COIN COLLECTION -->
      <div class="coins-wrap">
        <div class="coins-bar">
          <div class="counter"><span id="coinCount">0</span> MÃ¼nzen gesammelt</div>
          <div class="muted">Standort: <b id="kv_venue">â€“</b> Â· <span id="kv_time">â€“</span></div>
        </div>

        <div id="coinGrid" class="grid" aria-live="polite"></div>

        <!-- Legende ohne â€ž?â€œ-Hinweis -->
        <div class="muted" style="margin-top:8px;font-size:12px">Jede MÃ¼nze steht fÃ¼r einen eingelÃ¶sten QR-Code.</div>
      </div>

      <!-- USER ID -->
      <div class="idbox">
        <p><b>Deine CrunchClub-ID</b> (wie eine digitale Stempelkarte):</p>
        <div class="idrow">
          <code id="cid" class="mono idcode"></code>
          <button id="copyBtn" class="btn btn-primary">ðŸ“‹ Kopieren</button>
        </div>
        <p class="muted" style="margin-top:6px">
          Diese ID gut aufbewahren. Mit ihr bleibt deine Sammlung erhalten.
          Geht sie verloren (neues GerÃ¤t/Inkognito), beginnt die Karte von vorn.
        </p>
        <div id="welcome" class="chip ok" style="margin-top:8px; display:none">â˜… Willkommen im exklusiven CrunchClub!</div>
      </div>

      <!-- ACTIONS (ohne â€žID zurÃ¼cksetzenâ€œ) -->
      <div class="actions">
        <button id="retry" class="btn btn-primary">Erneut scannen</button>
        <a href="#" id="saveTxt" class="btn btn-ghost" download="CrunchClub-ID.txt">Als Notiz speichern</a>
      </div>
    </section>

    <footer>Anonyme Technikdaten: Zeit, Token, anonyme Client-ID. Kein Website-Tracking.</footer>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const qs = new URLSearchParams(location.search);

  // Client-ID
  function getCID(){
    try{
      let id = localStorage.getItem('cc_client_id');
      if(!id){ id = crypto.randomUUID(); localStorage.setItem('cc_client_id', id); }
      return id;
    }catch(e){ return '(kein Storage)'; }
  }

  // lokale Token-Sammlung (Set)
  function loadTokenSet(){
    try{ return new Set(JSON.parse(localStorage.getItem('cc_tokens')||'[]')); }catch(e){ return new Set(); }
  }
  function saveTokenSet(set){
    try{ localStorage.setItem('cc_tokens', JSON.stringify(Array.from(set))); }catch(e){}
  }

  // Query
  const registered = qs.get('registered');
  const state = (qs.get('state')||'').toLowerCase();
  const reason = (qs.get('reason')||'').toLowerCase();
  const ven = qs.get('ven') || 'crunchclub-zwickau';
  const tk  = qs.get('tk') || '';
  const tt  = Number(qs.get('tt')||0); // unique tokens total (Server)

  // Basics
  $('kv_time').textContent  = new Date().toLocaleString('de-DE');
  $('kv_venue').textContent = ven;
  const cid = getCID();
  $('cid').textContent = cid;

  // Notiz-Download Link setzen
  (function(){
    const body = `${cid}\nHinweis: Diese ID ist deine digitale Stempelkarte.`;
    const blob = new Blob([body], {type:'text/plain'});
    $('saveTxt').href = URL.createObjectURL(blob);
  })();

  // Kopierbutton
  $('copyBtn').onclick = () => {
    navigator.clipboard.writeText(cid).then(()=>{
      $('copyBtn').textContent = 'âœ” Kopiert';
      setTimeout(()=> $('copyBtn').textContent = 'ðŸ“‹ Kopieren', 1200);
    });
  };

  // Badge
  function setBadge(kind,msg){
    const b=$('badge');
    b.className='chip '+(kind==='ok'?'ok':kind==='warn'?'warn':kind==='err'?'err':'');
    b.textContent=msg;
  }

  // Sammlung pflegen
  const tokenSet = loadTokenSet();

  if (registered === '1') {
    if (state === 'new_member') {
      setBadge('ok','Neu registriert');
      $('headline').textContent = 'Level 1 erreicht!';
      $('explain').textContent  = 'Dein Abenteuer im CrunchClub hat begonnen.';
      $('welcome').style.display = 'inline-block';
      if (tk) tokenSet.add(tk);
    } else if (state === 'welcome_back') {
      setBadge('ok','Welcome Back');
      $('headline').textContent = 'MÃ¼nze eingesackt!';
      $('explain').textContent  = 'Du hast einen neuen QR-Code eingelÃ¶st.';
      if (tk) tokenSet.add(tk);
    } else if (state === 'already') {
      setBadge('warn','Code bereits eingelÃ¶st');
      $('headline').textContent = 'Schon eingesammelt.';
      $('explain').textContent  = 'Dieser QR-Code ist bei dir schon gewertet.';
    } else {
      setBadge('warn','Unklar');
      $('headline').textContent = 'Hmm â€¦';
      $('explain').textContent  = 'Kein klarer Status. Bitte QR erneut scannen.';
    }
  } else {
    const map={
      rate:['err','Zu viele Scans'],
      venue:['err','Falscher Standort'],
      invalid:['err','QR ungÃ¼ltig'],
      expired:['err','QR abgelaufen'],
      inactive:['err','QR deaktiviert'],
      param:['err','Parameter fehlen'],
      server:['err','Server-Fehler']
    };
    const v=map[reason]||['warn','Unklar'];
    setBadge(v[0],v[1]);
    $('headline').textContent='Fehler/Unklar';
    $('explain').textContent='Dieser Aufruf konnte nicht gewertet werden.';
  }

  // Speichern
  saveTokenSet(tokenSet);

  // Coins rendern â€“ ohne â€ž?â€œ-MÃ¼nzen
  const localCount = tokenSet.size;
  const total = Math.max(localCount, tt);
  const grid = $('coinGrid'); grid.innerHTML = '';
  for (let i=0;i<total;i++){
    const d=document.createElement('div');
    d.className='coin';
    grid.appendChild(d);
  }
  $('coinCount').textContent = String(total);

  // Erneut scannen
  $('retry').onclick = () => {
    if (document.referrer && /script\.google\.com/.test(document.referrer)) location.reload();
    else history.length>1 ? history.back() : window.location.assign('/');
  };
})();
</script>
</body>
</html>
