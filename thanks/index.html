<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>CrunchClub ‚Äì Registrierung</title>
  <meta name="color-scheme" content="light dark">
  <style>
    :root{
      --ok:#16a34a; --warn:#f59e0b; --err:#ef4444;
      --bg:#0b0f1a; --fg:#e5e7eb; --muted:#9ca3af; --card:#101726; --border:#1f2937;
    }
    @media (prefers-color-scheme: light){
      :root{ --bg:#f8fafc; --fg:#0f172a; --muted:#475569; --card:#ffffff; --border:#e2e8f0; }
    }
    *{box-sizing:border-box}
    body{
      margin:0; font:16px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg); color:var(--fg);
    }
    .wrap{max-width:720px;margin:0 auto;padding:20px}
    .card{background:var(--card); border:1px solid var(--border); border-radius:14px; padding:18px}
    h1{margin:0 0 8px;font-size:22px}
    .sub{color:var(--muted); font-size:13px}
    .badge{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:999px;border:1px solid}
    .b-ok{color:var(--ok);border-color:color-mix(in oklab, var(--ok) 60%, transparent)}
    .b-warn{color:var(--warn);border-color:color-mix(in oklab, var(--warn) 60%, transparent)}
    .b-err{color:var(--err);border-color:color-mix(in oklab, var(--err) 60%, transparent)}
    .grid{display:grid;grid-template-columns:120px 1fr;gap:6px 12px;margin:14px 0}
    .k{color:var(--muted);font-size:13px}
    .mono{font-family:ui-monospace,SFMono-Regular,Consolas,Menlo,monospace}
    .hint{margin-top:8px}
    .muted{color:var(--muted)}
    .row{display:flex;flex-wrap:wrap;gap:8px;margin-top:14px}
    button,a.btn{
      appearance:none;border:1px solid var(--border);background:transparent;color:var(--fg);
      padding:8px 12px;border-radius:10px;text-decoration:none;font-weight:600
    }
    .btn-primary{background:var(--fg); color:var(--bg); border-color:var(--fg)}
    footer{margin:18px 0;color:var(--muted);font-size:12px;text-align:center}
  </style>
</head>
<body>
  <div class="wrap">
    <header style="margin-bottom:14px">
      <h1>CrunchClub ‚Äì Registrierung</h1>
      <div class="sub">Zwickau ¬∑ anonym & ohne Anmeldung</div>
    </header>

    <section class="card" id="panel">
      <div id="badge" class="badge">Status wird gepr√ºft‚Ä¶</div>

      <div class="grid" style="margin-top:12px">
        <div class="k">Status</div><div id="kv_status">‚Äì</div>
        <div class="k">Standort</div><div id="kv_venue">‚Äì</div>
        <div class="k">Zeit</div><div id="kv_time">‚Äì</div>
        <div class="k">Client-ID</div><div id="kv_cid" class="mono" style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap">‚Äì</div>
        <div class="k">Code</div><div id="kv_token" class="mono">‚Äì</div>
      </div>

      <h2 id="headline" style="margin:6px 0 6px;font-size:18px">‚Äì</h2>
      <div id="explain" class="hint">‚Äì</div>

      <div id="counters" class="hint muted" style="display:none"></div>

      <div class="row">
        <button id="retry" class="btn-primary">Erneut scannen</button>
        <button id="reset">Client-ID zur√ºcksetzen</button>
        <a class="btn" href="#hours">√ñffnungszeiten</a>
        <a class="btn" href="https://instagram.com/crunchclub_zwickau" target="_blank" rel="noopener">Instagram</a>
      </div>
    </section>

    <section id="hours" class="card" style="margin-top:12px">
      <strong>√ñffnungszeiten</strong>
      <div id="hoursGrid" class="grid" style="margin-top:8px"></div>
      <div class="muted" style="font-size:12px;margin-top:6px">üìç Innere Schneeberger Str. 17, 08056 Zwickau</div>
    </section>

    <footer>
      Es werden nur anonyme technische Daten verarbeitet (Zeit, Token, anonyme Client-ID). Kein Tracking √ºber Websites hinweg.
    </footer>
  </div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const qs = new URLSearchParams(location.search);

  // Helpers
  const getCID = () => {
    try {
      let id = localStorage.getItem('cc_client_id');
      if (!id) { id = crypto.randomUUID(); localStorage.setItem('cc_client_id', id); }
      return id;
    } catch { return '(kein Storage)'; }
  };
  const resetCID = () => { try{ localStorage.removeItem('cc_client_id'); location.reload(); }catch{} };

  // Hours
  const HOURS = [
    ['Montag','11:00 ‚Äì 21:00'],
    ['Dienstag','11:00 ‚Äì 21:00'],
    ['Mittwoch','11:00 ‚Äì 21:00'],
    ['Donnerstag','11:00 ‚Äì 21:00'],
    ['Freitag','11:00 ‚Äì 21:30'],
    ['Samstag','11:00 ‚Äì 21:30'],
    ['Sonntag','geschlossen'],
  ];
  const dayMap=[6,0,1,2,3,4,5];
  const todayIdx = dayMap[new Date().getDay()];
  $('hoursGrid').innerHTML = HOURS.map((d,i)=>`
    <div class="k" style="${i===todayIdx?'font-weight:700;color:inherit':''}">${d[0]}</div>
    <div style="${i===todayIdx?'font-weight:700':''}">${d[1]}</div>
  `).join('');

  // Values from redirect
  const registered = qs.get('registered'); // "1" | "0"
  const state = (qs.get('state')||'').toLowerCase(); // new_member|welcome_back|already
  const reason = (qs.get('reason')||'').toLowerCase();
  const ven = qs.get('ven') || 'crunchclub-zwickau';
  const tk  = qs.get('tk') || '';
  const mt  = Number(qs.get('mt')||0);
  const tt  = Number(qs.get('tt')||0);
  const tsc = Number(qs.get('tsc')||0);
  const camp= qs.get('camp') || '';

  // Fill basics
  $('kv_time').textContent  = new Date().toLocaleString('de-DE');
  $('kv_venue').textContent = ven;
  $('kv_cid').textContent   = getCID();
  $('kv_token').textContent = tk || '‚Äî';

  // Badge / copy text
  const setBadge = (cls, text) => {
    const b = $('badge');
    b.className = `badge ${cls}`;
    b.textContent = text;
  };

  // Render states
  if (registered === '1') {
    $('counters').style.display = 'block';
    $('counters').textContent = `Besuche gesamt: ${mt} ‚Ä¢ Einzigartige Codes: ${tt}` + (tk ? ` ‚Ä¢ Scans dieses Codes: ${tsc}`:'');
    switch (state) {
      case 'new_member':
        setBadge('b-ok','‚úì Registrierung erfolgreich (Erstbesuch)');
        $('kv_status').textContent = 'Neu registriert';
        $('headline').textContent = 'Willkommen beim CrunchClub!';
        $('explain').innerHTML = `Deine Mitgliedschaft wurde angelegt.${tk ? ' <span class="mono" style="padding:2px 6px;border:1px solid var(--border);border-radius:8px">Code: '+tk+'</span>':''}` + (camp? `<div class="muted" style="margin-top:6px">Kampagne: ${camp}</div>` : '');
        break;
      case 'welcome_back':
        setBadge('b-ok','‚úì Welcome back ‚Äì neuer Code gez√§hlt');
        $('kv_status').textContent = 'Welcome Back';
        $('headline').textContent = 'Sch√∂n, dich wiederzusehen!';
        $('explain').innerHTML = `Dieser Code ist neu f√ºr dich.${tk ? ' <span class="mono" style="padding:2px 6px;border:1px solid var(--border);border-radius:8px">Code: '+tk+'</span>':''}` + (camp? `<div class="muted" style="margin-top:6px">Kampagne: ${camp}</div>` : '');
        break;
      case 'already':
        setBadge('b-warn','‚ÑπÔ∏è Code bereits eingel√∂st');
        $('kv_status').textContent = 'Bereits eingel√∂st';
        $('headline').textContent = 'Diesen Code hast du schon benutzt';
        $('explain').innerHTML = `${tk ? '<span class="mono" style="padding:2px 6px;border:1px solid var(--border);border-radius:8px">Code: '+tk+'</span> ' : ''}Keine doppelte Gutschrift ‚Äì beim n√§chsten Besuch bitte neuen QR scannen.`;
        break;
      default:
        setBadge('b-warn','‚ÑπÔ∏è Unklarer Status');
        $('kv_status').textContent = 'Unbekannt';
        $('headline').textContent  = 'Bitte QR erneut scannen';
        $('explain').textContent   = 'Diese Seite wurde ohne klaren Status aufgerufen.';
    }
  } else {
    const map = {
      rate:   ['b-err','‚ö†Ô∏è Zu viele Scans','Kurz warten und erneut scannen','Bitte 1‚Äì2 Minuten warten und dann erneut versuchen.'],
      venue:  ['b-err','‚ö†Ô∏è Falscher Standort','Dieser QR gilt hier nicht','Bitte den QR f√ºr diesen Standort verwenden.'],
      invalid:['b-err','‚ö†Ô∏è QR ung√ºltig','Dieser QR ist nicht g√ºltig','Der QR ist veraltet oder fehlerhaft. Bitte aktuellen QR scannen.'],
      expired:['b-err','‚ö†Ô∏è QR abgelaufen','Dieser QR ist abgelaufen','Bitte aktuellen QR am Tresen verwenden.'],
      inactive:['b-err','‚ö†Ô∏è QR deaktiviert','Dieser QR ist deaktiviert','Bitte neuen QR am Tresen anfordern.'],
      param: ['b-err','‚ö†Ô∏è Parameter fehlen','Ung√ºltiger Aufruf','Bitte QR erneut scannen.'],
      server:['b-err','‚ö†Ô∏è Vor√ºbergehender Fehler','Da ist etwas schiefgelaufen','Bitte in wenigen Minuten erneut versuchen.'],
    };
    const v = map[reason] || ['b-warn','‚ÑπÔ∏è Unklarer Status','Bitte QR erneut scannen','Diese Seite wurde ohne klaren Status ge√∂ffnet.'];
    setBadge(v[0], v[1]);
    $('kv_status').textContent = v[1].replace(/^‚ö†Ô∏è\s*/,'');
    $('headline').textContent  = v[2];
    $('explain').textContent   = v[3];
  }

  // Actions
  $('retry').onclick = () => {
    if (document.referrer && /script\.google\.com/.test(document.referrer)) location.reload();
    else history.length>1 ? history.back() : window.location.assign('/');
  };
  $('reset').onclick = resetCID;
})();
</script>
</body>
</html>
